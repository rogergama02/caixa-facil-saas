<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CaixaFácil — Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg:#0f1724; --card:#0b1220; --accent:#7c3aed; 
      --muted:#9aa4b2; --glass:rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    body{margin:0;background:linear-gradient(180deg,#071025 0%,#071726 100%);color:#e6eef6;min-height:100vh}
    .wrap{max-width:1200px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:22px}
    .brand{display:flex;gap:12px;align-items:center}

    /* ✅ Logo somente imagem */
    .logo {
      width:46px;
      height:46px;
      border-radius:8px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .logo img {
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:8px;
    }

    h1{font-size:1.1rem;margin:0}
    .subtitle{color:var(--muted);font-size:.85rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px}
    .card{background:var(--card);border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .card h2{font-size:1rem;margin:0 0 12px}
    .meta{font-size:.8rem;color:var(--muted);margin-top:6px}
    canvas{max-width:100%;height:280px!important}
    .filters{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    input,select{background:var(--glass);border:1px solid rgba(255,255,255,0.08);padding:8px 10px;border-radius:8px;color:#e6eef6}
    button{background:var(--accent);border:none;padding:9px 14px;border-radius:8px;color:white;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <!-- ✅ Agora a logo aceita imagem -->
        <div class="logo"><img src="ChatGPT Image 3 de set. de 2025, 11_33_391.png" alt="CaixaFácil"></div>
        <div>
          <h1>Dashboard Financeiro</h1>
          <div class="subtitle">Visão geral do seu caixa</div>
        </div>
      </div>
      <div style="display:flex; gap:8px;">
        <button onclick="window.location.href='index.html'">← Voltar</button>
        <button onclick="window.location.href='login.html'">Sair</button>
      </div>
    </header>

    <div class="filters">
      <label>De: <input type="date" id="fromDate"></label>
      <label>Até: <input type="date" id="toDate"></label>
      <button onclick="renderAll()">Filtrar</button>
    </div>

    <section class="grid" style="margin-top:16px">
      <div class="card">
        <h2>Saldo & Projeção</h2>
        <div style="font-size:1.8rem;font-weight:700" id="saldo">R$ 0,00</div>
        <div class="meta">Projeção 30d: <span id="proj">R$ 0,00</span></div>
      </div>

      <div class="card">
        <h2>Receitas vs Despesas (30d)</h2>
        <canvas id="barChart"></canvas>
      </div>

      <div class="card">
        <h2>Fluxo de Caixa (30d)</h2>
        <canvas id="lineChart"></canvas>
      </div>

      <div class="card">
        <h2>Distribuição por Categoria</h2>
        <canvas id="pieChart"></canvas>
      </div>
    </section>
  </div>

<script>
// Guard: auth + assinatura
(async () => {
  const r = await fetch('/api/me', { credentials:'include' });
  if (r.status === 401) return location.href = 'login.html';
  const me = await r.json();
  if (!me.subscription_active) return location.href = 'payment.html';
})();

const API = "/api/tx";
const format = v => v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

async function load(){
  const res = await fetch(API, { credentials:'include' });
  if (res.status === 401) return location.href='login.html';
  if (res.status === 402) return location.href='payment.html';
  return await res.json();
}

async function filterTxs(){
  const txs = await load();
  const f = document.getElementById('fromDate').value;
  const t = document.getElementById('toDate').value;
  return txs.filter(tx=>{
    const d = new Date(tx.date);
    if(f && d<new Date(f)) return false;
    if(t && d>new Date(t)) return false;
    return true;
  });
}

let barChart,lineChart,pieChart;

async function renderAll(){
  const txs = await filterTxs();

  // Saldo
  const saldo=txs.reduce((s,t)=>s+Number(t.amount),0);
  document.getElementById('saldo').textContent=format(saldo);
  const rev30=txs.filter(t=>t.amount>0).reduce((s,t)=>s+Number(t.amount),0);
  const exp30=txs.filter(t=>t.amount<0).reduce((s,t)=>s+Math.abs(Number(t.amount)),0);
  document.getElementById('proj').textContent=format(saldo+(rev30-exp30));

  // Gráfico barras
  const barCtx=document.getElementById('barChart').getContext('2d');
  if(barChart) barChart.destroy();
  barChart=new Chart(barCtx,{
    type:'bar',
    data:{labels:['Receitas','Despesas'],datasets:[{
      data:[rev30,exp30],
      backgroundColor:['rgba(16,185,129,0.7)','rgba(239,68,68,0.7)'],
      borderRadius:6
    }]},
    options:{plugins:{legend:{display:false}}}
  });

  // Gráfico linha (saldo acumulado últimos 30 dias)
  const last30=[...Array(30)].map((_,i)=>{const d=new Date();d.setDate(d.getDate()-29+i);return d});
  let acumulado=0;
  const saldoDia=[];
  last30.forEach(d=>{
    const total=txs.filter(t=>new Date(t.date).toDateString()==d.toDateString())
                  .reduce((s,t)=>s+Number(t.amount),0);
    acumulado+=total;
    saldoDia.push(acumulado);
  });
  const lineCtx=document.getElementById('lineChart').getContext('2d');
  if(lineChart) lineChart.destroy();
  lineChart=new Chart(lineCtx,{
    type:'line',
    data:{
      labels:last30.map(d=>d.toLocaleDateString('pt-BR')),
      datasets:[{
        label:'Saldo acumulado',
        data:saldoDia,
        fill:false,
        borderColor:'rgba(124,58,237,0.9)',
        backgroundColor:'rgba(124,58,237,0.3)',
        tension:0.25,
        pointRadius:3,
        pointBackgroundColor:'#7c3aed'
      }]
    },
    options:{plugins:{legend:{display:false}},scales:{x:{ticks:{maxTicksLimit:6}}}}
  });

  // Pizza categorias
  const cats={};
  txs.forEach(t=>{cats[t.cat]=(cats[t.cat]||0)+Math.abs(Number(t.amount))});
  const pieCtx=document.getElementById('pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart=new Chart(pieCtx,{
    type:'pie',
    data:{
      labels:Object.keys(cats),
      datasets:[{
        data:Object.values(cats),
        backgroundColor:['#7c3aed','#4f46e5','#10b981','#ef4444','#f59e0b','#3b82f6']
      }]
    }
  });
}

renderAll();
</script>
</body>
</html>
